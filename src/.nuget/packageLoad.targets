<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" InitialTargets="_RestoreBuildTools" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    Contains targets to do NuGet packages. The following tasks need to be performed:
        Parameters:
          NuGetConfigDir         - this directory may contain the following files:
                                   NuGet.Config - configuration file
                                   packages.config - old-facioned way to installed packages
                                   packages.Linux.config - old-facioned way to install packages for Linux
                                   packages.Windows_NT.config - old-facioned way to install packages for Windows
                                   project.json - new way to install packages
          NuGetDir               - location to install packages
          SolutionRoot           - Process all project.json files under this directory. Excludes project.json in NuGetConfigDir.
          InstallationDependency - list of files that, when changed, need to cause reinstall
          BuildToolsSemaphore    - Created when build tools are restored
        1. Downloads NuGet.exe
        2. Use NuGet.exe to process packages.*.config and download packages it specifies into $(NuGetDir)
        3. Handle project.json installation. This allows loading specific runtime
  -->

  <!-- These properties are related to NuGet -->
  <PropertyGroup>
    <PackagesCache Condition="'$(OsEnvironment)'=='Windows_NT'">$([System.IO.Path]::Combine($(USERPROFILE), '.nuget', 'packages'))</PackagesCache>
    <PackagesCache Condition="'$(OsEnvironment)'!='Windows_NT'">$([System.IO.Path]::Combine($(HOME), '.nuget', 'packages'))</PackagesCache>
    <NuGetToolPath Condition="'$(NuGetToolPath)'==''">$([System.IO.Path]::Combine($(NuGetDir), "NuGet.exe"))</NuGetToolPath>
    <NuGetConfigFile>$([System.IO.Path]::Combine($(NuGetConfigDir),"NuGet.Config"))</NuGetConfigFile>
    <NuGetPackagesFile>$([System.IO.Path]::Combine($(NuGetConfigDir),"packages.config"))</NuGetPackagesFile>
    <NuGetPackagesFileTargetSpecific>$([System.IO.Path]::Combine($(NuGetConfigDir),"packages.$(OS).config"))</NuGetPackagesFileTargetSpecific>
    <NuGetProjectJsonFile>$([System.IO.Path]::Combine($(NuGetConfigDir),"project.json"))</NuGetProjectJsonFile>
    <NuGetProjectLockJsonFile>$([System.IO.Path]::Combine($(NuGetConfigDir),"project.lock.json"))</NuGetProjectLockJsonFile>
    <NuGetCommonOptions></NuGetCommonOptions>
    <NuGetPackageInstallOptions>-OutputDirectory &quot;$(NuGetDir.TrimEnd('\').TrimEnd('\'))&quot; -ConfigFile &quot;$(RepoRoot)/NuGet.Config&quot;</NuGetPackageInstallOptions>
    <NuGetPackageRestoreOptions>-ConfigFile &quot;$(RepoRoot)/NuGet.Config&quot;</NuGetPackageRestoreOptions>
    <!-- UNDO: When fixed https://github.com/NuGet/Home/issues/1517 -->
    <NuGetPackageRestoreOptions Condition="'$(OsEnvironment)'!='Windows_NT'">$(NuGetPackageRestoreOptions) -PackagesDirectory "$(PackagesCache)"</NuGetPackageRestoreOptions>
    <NuGetRestoreCommand>$(NuGetToolPath) restore $(NuGetCommonOptions)</NuGetRestoreCommand>
    <NuGetRestoreCommand Condition="'$(OsEnvironment)'!='Windows_NT'">MONO_THREADS_PER_CPU=2000 mono --server $(NuGetRestoreCommand)</NuGetRestoreCommand>
    <NuGetInstallCommand>$(NuGetToolPath) install $(NuGetCommonOptions)</NuGetInstallCommand>
    <NuGetInstallCommand Condition="'$(OsEnvironment)'!='Windows_NT'">MONO_THREADS_PER_CPU=2000 mono --server $(NuGetInstallCommand)</NuGetInstallCommand>
    <NugetVersion>v3.3.0</NugetVersion>
    <NugetDownloadURL>https://dist.nuget.org/win-x86-commandline/$(NugetVersion)/nuget.exe</NugetDownloadURL>
    <NugetExeSemaphore>$(NuGetDir)NuGet.$(NugetVersion).semaphore</NugetExeSemaphore>
    <DownloadCommand Condition="'$(OsEnvironment)'=='Windows_NT'">powershell -noprofile -nologo -command "(new-object System.Net.WebClient).DownloadFile('$(NugetDownloadURL)', '$(NuGetToolPath)')"</DownloadCommand>
    <DownloadCommand Condition="'$(OsEnvironment)'!='Windows_NT'">curl -sSL --create-dirs -o $(NuGetToolPath) $(NugetDownloadURL)</DownloadCommand>
    <BuildToolsSemaphore>$(NuGetDir)BuildTools.semaphore</BuildToolsSemaphore>
  </PropertyGroup>

  <!-- These are properties for the dnu -->
  <PropertyGroup>
    <SetDnxPackages Condition="'$(OsEnvironment)'=='Windows_NT'">set DNX_PACKAGES=$(PackagesCache) &amp;</SetDnxPackages>
    <SetDnxPackages Condition="'$(OsEnvironment)'!='Windows_NT'">export DNX_PACKAGES=$(PackagesCache) ;</SetDnxPackages>
    <DnuRestoreCommand>$(SetDnxPackages) $(DnuToolPath) restore  --parallel </DnuRestoreCommand>
  </PropertyGroup>

  <ItemGroup>
     <ProjectJsonFile Include="$(SolutionRoot)**\project.json" Exclude="$(NuGetConfigDir)\project.json" />
     <!--
     <ProjectJsonFile Include="$(SolutionRoot)**\project.json" />
     -->
  </ItemGroup>

  <PropertyGroup>
    <RestoreBuildToolsPackagesConfigInputs>$(GlobalPropertiesFile);$(NuGetPackagesFile)</RestoreBuildToolsPackagesConfigInputs>
    <!-- Make sure we don't use a file that doesn't exist as one of our inputs, otherwise the target will always be built even if it's up-to-date -->
    <RestoreBuildToolsPackagesConfigInputs Condition="Exists('$(NuGetPackagesFileTargetSpecific)')">$(RestoreBuildToolsPackagesConfigInputs);$(NuGetPackagesFileTargetSpecific)</RestoreBuildToolsPackagesConfigInputs>
  </PropertyGroup>

  <!-- Restore NuGet.exe and use it to process Nuget.config. -->
  <Target Name="_RestoreBuildToolsPackagesConfig"
          Inputs="$(RestoreBuildToolsPackagesConfigInputs)"
          Outputs="$(BuildToolsSemaphore);$(NugetExeSemaphore);$(NuGetToolPath)"
          Condition="Exists('$(NuGetPackagesFile)') or Exists('$(NuGetPackagesFileTargetSpecific)')">
    <Message Importance="High" Text="Restoring build tools..." />

    <MakeDir Directories="$(NuGetDir)"
             Condition="!Exists('$(NuGetDir)')" />

    <!-- Download NuGet.exe -->
    <Exec Command="$(DownloadCommand)" Condition="!Exists('$(NugetExeSemaphore)')" />

    <Touch Files="$(NuGetToolPath)" />

    <Touch Files="$(NugetExeSemaphore)"
           ContinueOnError="WarnAndContinue"
           AlwaysCreate="true"
           ForceTouch="true" />


    <!-- Restore build tools using packages.config if it exists -->
    <Exec Condition="Exists('$(NuGetPackagesFile)')" Command="$(NugetInstallCommand) $(NuGetPackageInstallOptions) &quot;$(NuGetPackagesFile)&quot;" />
    <Exec Condition="Exists('$(NuGetPackagesFileTargetSpecific)')" Command="$(NugetInstallCommand) $(NuGetPackageInstallOptions) &quot;$(NuGetPackagesFileTargetSpecific)&quot;" />
    <Error Condition="'$(ErrorIfBuildToolsRestoredFromIndividualProject)'=='true'"
           Text="The build tools package was just restored and so we cannot continue the build of an individual project because targets from the build tools package were not able to be imported. Please retry the build the individual project again." />

    <!--
      Touch our semaphore file to ensure Inputs/Outputs comparison for this target will show that we're up to date.
      Ignore failures in the unlikely, but possible, event that we hit this from two projects simultaneously.
    -->
    <Touch Files="$(BuildToolsSemaphore)"
           ContinueOnError="WarnAndContinue"
           AlwaysCreate="true"
           ForceTouch="true" />
    
  </Target>

  <!-- All work is done in the dependent targets -->
  <Target Name="_RestoreGlobalReferences" DependsOnTargets="_RestoreBuildToolsPackagesConfig">

  </Target>

  <!-- Make all files readable and everything, except *.dll, *.xml, and *.nupkg, executable -->
  <Target Name="_UpdateExecPermissions"
          AfterTargets="_RestoreGlobalReferences"
          BeforeTargets="_RestoreDnuProjectJsonReferences"
          Condition="'$(OsEnvironment)'!='Windows_NT'">

    <Exec Command="find &quot;$(DnuToolDir)&quot; -type f -a -name &quot;*&quot; -a \! -iname &quot;*.dll&quot; -a \! -iname &quot;*.xml&quot; -a \! -iname &quot;*.nupkg&quot; -a \! -iname &quot;*.so&quot; -print0 | xargs -0 -I {} chmod a+xr {}" />

  </Target>

  <Target Name="_RestoreDnuProjectJsonReferences"
          Inputs="@(ProjectJsonFile)"
          Outputs="%(ProjectJsonFile.RootDir)%(ProjectJsonFile.Directory)project.lock.json"
          AfterTargets="_RestoreGlobalReferences" >
    <PropertyGroup>
      <ProjectDirectory>%(ProjectJsonFile.RootDir)%(ProjectJsonFile.Directory)</ProjectDirectory>
    </PropertyGroup>

    <Message Importance="High" Text="Restoring in $(ProjectDirectory)" />

    <!-- TODO: Restore back to Nuget once Nuget works -->
    <!-- Restore packages for this directory using Nuget-->
    <!-- <Exec Command="$(NugetRestoreCommand) $(NuGetPackageRestoreOptions) -PackagesDirectory &quot;$(HOME)/.nuget/packages&quot; &quot;@(ProjectJsonFile)&quot;" />  -->
    
    <!-- Restore packages for this directory using DNU-->
    <Exec Condition="'$(OsEnvironment)'!='Windows_NT'" Command="$(DnuRestoreCommand) &quot;@(ProjectJsonFile)&quot;" />
  </Target>

  <!--
     Call all targets:
       _RestoreBuildToolsNugetConfig - download NuGet.exe and restore packages via packages.config
       _RestoreSolution - If solution file is provided, use it to restore all packages of projects
       _RestoreDnuProjectJsonReferences - Without solution, use dnu and process all project.json files
  -->
  <Target Name="_RestoreBuildTools" DependsOnTargets="_RestoreGlobalReferences" />

</Project>
